services:
  doc-to-pdf:
    build: .
    expose:
      - "8000"
    environment:
      - CONVERSION_TIMEOUT=120
      - MAX_FILE_SIZE=52428800
      - SHARED_DIR=/shared
      # - API_KEY=your-secret-key  # Uncomment for production
    volumes:
      - shared-files:/shared
    depends_on:
      - onlyoffice
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  onlyoffice:
    image: onlyoffice/documentserver:latest
    environment:
      - JWT_ENABLED=false
    volumes:
      - shared-files:/shared
      - ./fonts:/usr/share/fonts/truetype/custom-extra:ro
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        # Update font cache if custom fonts exist
        if [ -d /usr/share/fonts/truetype/custom-extra ] && [ "$$(ls -A /usr/share/fonts/truetype/custom-extra 2>/dev/null)" ]; then
            echo "Updating font cache for custom fonts..."
            fc-cache -f -v /usr/share/fonts/truetype/custom-extra
        fi
        # Start converter worker in background
        (
            while [ ! -f /var/www/onlyoffice/documentserver/server/FileConverter/bin/x2t ]; do
                sleep 5
            done
            echo "Starting converter worker..."
            mkdir -p /shared
            X2T_PATH="/var/www/onlyoffice/documentserver/server/FileConverter/bin/x2t"
            while true; do
                for marker in /shared/*.convert; do
                    [ -e "$$marker" ] || continue
                    job_id=$$(basename "$$marker" .convert)
                    config_file=$$(cat "$$marker")
                    config_path="/shared/$$config_file"
                    echo "Processing job: $$job_id"
                    rm -f "$$marker"
                    if [ -f "$$config_path" ]; then
                        if "$$X2T_PATH" "$$config_path" 2>/tmp/x2t_error_$$job_id.log; then
                            echo "Job $$job_id completed successfully"
                            touch "/shared/$$job_id.done"
                        else
                            echo "Job $$job_id failed"
                            cat /tmp/x2t_error_$$job_id.log > "/shared/$$job_id.error"
                            rm -f /tmp/x2t_error_$$job_id.log
                        fi
                    else
                        echo "Config file not found: $$config_path"
                        echo "Config file not found" > "/shared/$$job_id.error"
                    fi
                done
                sleep 0.3
            done
        ) &
        exec /app/ds/run-document-server.sh
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/healthcheck"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 180s
    restart: unless-stopped

volumes:
  shared-files:
